<script>
        // --- PASTE YOUR RENDER URL HERE ---
        const backendUrl = 'https://yash-slr-waste-project.onrender.com';
        // ---------------------------------

        // --- Get ALL Elements ---
        // ... (Keep all the element variables from the previous version) ...
        const userEmailSpan = document.getElementById('user-email');
        const authContainer = document.getElementById('auth-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        const loginCard = document.getElementById('login-card');
        const registerCard = document.getElementById('register-card');
        const registerNgoCard = document.getElementById('register-ngo-card');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const registerNgoForm = document.getElementById('register-ngo-form');
        const loginMessage = document.getElementById('login-message');
        const registerMessage = document.getElementById('register-message');
        const registerNgoMessage = document.getElementById('register-ngo-message');
        const showRegisterLink = document.getElementById('show-register-link');
        const showRegisterNgoLink = document.getElementById('show-register-ngo-link');
        const showLoginLinks = document.querySelectorAll('.show-login-link');
        const logoutBtn = document.getElementById('logout-btn');
        const userPanel = document.getElementById('user-panel-col');
        const adminPanel = document.getElementById('admin-panel-col');
        const driverPanel = document.getElementById('driver-panel-col');
        const pickupForm = document.getElementById('pickup-form');
        const formMessage = document.getElementById('form-message');
        const adminPickupsList = document.getElementById('admin-pickups-list');
        const refreshBtn = document.getElementById('refresh-btn');
        const getRouteBtn = document.getElementById('get-route-btn');
        const routeList = document.getElementById('route-list');


        // --- Helper functions ---
        function getToken() { return localStorage.getItem('token'); }
        function getUser() { return JSON.parse(localStorage.getItem('user')); }
        function handleAuthError(error) {
            console.error('Auth error:', error);
            logout();
        }
        function showAuth() {
            authContainer.style.display = 'block';
            dashboardContainer.style.display = 'none';
            loginCard.style.display = 'block';
            registerCard.style.display = 'none';
            registerNgoCard.style.display = 'none';
        }
        function showDashboard() {
            const user = getUser();
            if (!user) { showAuth(); return; }
            authContainer.style.display = 'none';
            dashboardContainer.style.display = 'block';
            userEmailSpan.textContent = user.email;

            // Role-based visibility
            userPanel.style.display = 'none';
            adminPanel.style.display = 'none';
            driverPanel.style.display = 'none';
            // NGO/Donation panels will be added later

            if (user.role === 'user') userPanel.style.display = 'block';
            else if (user.role === 'driver') driverPanel.style.display = 'block';
            else if (user.role === 'admin') adminPanel.style.display = 'block';
            // else if (user.role === 'ngo') // Add NGO panel display later

            if (user.role === 'admin') fetchAllPickups(); // Fetch initial data
        }

        // --- Fetch Functions (with Authorization Header) ---
        async function makeAuthenticatedRequest(url, options = {}) {
            const token = getToken();
            const headers = {
                ...options.headers,
                'Content-Type': 'application/json', // Default Content-Type
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(url, { ...options, headers });

            if (response.status === 401 || response.status === 403) {
                // If unauthorized or forbidden, log out
                handleAuthError(new Error(`Authorization failed: ${response.status}`));
                throw new Error('Authorization Failed'); // Stop further processing
            }
            if (!response.ok) {
                // Try to get error message from backend
                const errorData = await response.json().catch(() => ({})); // Catch if response is not JSON
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }
            return response.json(); // Return parsed JSON for successful responses
        }

        function fetchAllPickups() {
            adminPickupsList.innerHTML = '<li class="list-group-item">Loading pickups...</li>';
            makeAuthenticatedRequest(backendUrl + '/api/pickups')
                .then(data => {
                    adminPickupsList.innerHTML = '';
                    if (!data || data.length === 0) {
                        adminPickupsList.innerHTML = '<li class="list-group-item">No pickups scheduled.</li>'; return;
                    }
                    data.forEach(pickup => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-start';
                        li.dataset.id = pickup._id;
                        let statusColor = pickup.status === 'Pending' ? 'text-warning' : 'text-success';
                        li.innerHTML = `
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">${pickup.wasteType}</div>
                                <small>${pickup.address}</small><br>
                                <span class="fw-bold ${statusColor}">${pickup.status}</span>
                            </div>
                        `;
                        if (pickup.status === 'Pending') {
                            const completeBtn = document.createElement('button');
                            completeBtn.innerHTML = '<i class="bi bi-check-lg"></i>';
                            completeBtn.className = 'btn btn-primary btn-sm btn-grad-purple text-white complete-btn';
                            li.appendChild(completeBtn);
                        }
                        adminPickupsList.appendChild(li);
                    });
                })
                .catch(error => {
                    if (error.message !== 'Authorization Failed') { // Avoid double logout
                       adminPickupsList.innerHTML = `<li class="list-group-item list-group-item-danger">Could not load pickups: ${error.message}</li>`;
                    }
                });
        }

        function completePickup(pickupId) {
             makeAuthenticatedRequest(`${backendUrl}/api/pickups/${pickupId}/complete`, { method: 'PATCH' })
                .then(data => { if (data.message) fetchAllPickups(); })
                .catch(error => {
                     if (error.message !== 'Authorization Failed') alert('Error: Could not complete pickup.');
                 });
        }

        function fetchOptimizedRoute() {
            routeList.innerHTML = '<li class="list-group-item">Calculating route...</li>';
            makeAuthenticatedRequest(backendUrl + '/api/driver/route')
                .then(data => {
                    routeList.innerHTML = '';
                    if (!data.pickups || data.pickups.length === 0) {
                        routeList.innerHTML = `<li class="list-group-item">${data.message || 'No pending pickups.'}</li>`; return;
                    }
                    data.pickups.forEach(pickup => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.innerHTML = `<strong>${pickup.address}</strong> (${pickup.wasteType})`;
                        routeList.appendChild(li);
                    });
                })
                .catch(error => {
                    if (error.message !== 'Authorization Failed') {
                        routeList.innerHTML = `<li class="list-group-item list-group-item-danger">Could not fetch route: ${error.message}</li>`;
                    }
                });
        }

        // --- On Page Load ---
        window.addEventListener('load', () => {
            const token = getToken();
            if (token) showDashboard();
            else showAuth();
        });

        // --- Event Listener for Pickup Form (User) ---
        pickupForm.addEventListener('submit', (event) => {
            event.preventDefault();
            formMessage.textContent = 'Submitting...';
            formMessage.className = 'text-muted';
            makeAuthenticatedRequest(backendUrl + '/api/schedule', {
                method: 'POST',
                body: JSON.stringify({
                    wasteType: document.getElementById('wasteType').value,
                    address: document.getElementById('address').value
                }),
            })
            .then(data => {
                formMessage.textContent = data.message;
                formMessage.className = 'text-success';
                pickupForm.reset();
            })
            .catch(error => {
                if (error.message !== 'Authorization Failed') {
                    formMessage.textContent = 'Error: ' + error.message;
                    formMessage.className = 'text-danger';
                }
            });
        });

        // --- Event Listeners for Admin Panel ---
        refreshBtn.addEventListener('click', fetchAllPickups);
        adminPickupsList.addEventListener('click', (event) => {
            const clickedButton = event.target.closest('.complete-btn');
            if (clickedButton) {
                const pickupLi = clickedButton.closest('li');
                completePickup(pickupLi.dataset.id);
            }
        });

        // --- Event Listener for Driver Panel ---
        getRouteBtn.addEventListener('click', fetchOptimizedRoute);

        // --- Event Listeners for Auth ---
        showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); loginCard.style.display = 'none'; registerCard.style.display = 'block'; registerNgoCard.style.display = 'none'; });
        showRegisterNgoLink.addEventListener('click', (e) => { e.preventDefault(); loginCard.style.display = 'none'; registerCard.style.display = 'none'; registerNgoCard.style.display = 'block'; });
        showLoginLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); showAuth(); }); });

        // --- UPDATED LOGIN FORM SUBMIT ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            loginMessage.textContent = 'Logging in...';
            loginMessage.className = 'mt-3 text-center text-muted';

            fetch(backendUrl + '/api/auth/login', { // Public endpoint, no auth needed
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            })
            .then(response => {
                // Explicitly check for non-OK status codes like 400 or 401
                if (!response.ok) {
                    return response.json().then(errData => {
                        // Throw error with message from backend
                        throw new Error(errData.message || `Login failed (${response.status})`);
                    });
                }
                return response.json(); // Success, parse JSON
            })
            .then(data => {
                if (data.token && data.user) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    showDashboard(); // Switch to dashboard view
                } else {
                     // Should not happen if backend is correct, but good fallback
                    throw new Error('Login failed: Invalid response from server.');
                }
            })
            .catch(err => {
                console.error("Login Error:", err); // Log full error
                loginMessage.textContent = err.message; // Show specific error message
                loginMessage.className = 'mt-3 text-center text-danger';
            });
        });

        // --- Register NGO Form Submit ---
        registerNgoForm.addEventListener('submit', (e) => {
             e.preventDefault();
             registerNgoMessage.textContent = 'Registering...';
             registerNgoMessage.className = 'mt-3 text-center text-muted';
             const ngoData = { /* ... */ }; // Get data same as before
             fetch(backendUrl + '/api/auth/register-ngo', { /* ... */ }) // Public endpoint
                 .then(response => response.json())
                 .then(data => { /* ... */ }) // Same message handling
                 .catch(err => { /* ... */ }); // Same error handling
        });

        // --- Register User Form Submit ---
        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            registerMessage.textContent = 'Registering...';
            registerMessage.className = 'mt-3 text-center text-muted';
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            fetch(backendUrl + '/api/auth/register', { /* ... */ }) // Public endpoint
                 .then(response => response.json())
                 .then(data => { /* ... */ }) // Same message handling
                 .catch(err => { /* ... */ }); // Same error handling
        });

        // --- Logout Function ---
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            showAuth();
        }
        logoutBtn.addEventListener('click', logout);

    </script>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Waste Management System</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f9f9f9; }
        h1 { color: #16a085; text-align: center; }
        h2 { border-bottom: 2px solid #16a085; padding-bottom: 5px; }
        
        /* Layout */
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .panel {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            width: 30%;
            min-width: 350px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
  
        #status-box { text-align: center; background-color: #f0f0f0; padding: 15px; border-radius: 8px; max-width: 1100px; margin: 20px auto; }

        input[type="text"] { width: 95%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; }
        button { background-color: #16a085; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #1abc9c; }

        .pickup-list { list-style: none; padding: 0; }
        .pickup-list li { background-color: #fafafa; border: 1px solid #ccc; padding: 10px; margin-bottom: 8px; border-radius: 4px; }
        .pickup-list li strong { color: #333; }
        
       
        .complete-btn { background-color: #3498db; padding: 5px 10px; font-size: 0.8em; float: right; }
        .complete-btn:hover { background-color: #2980b9; }

    
        #route-list { list-style-type: decimal; padding-left: 20px; }
    </style>
</head>
<body>
    <h1>Inorganic Waste & Scrap Management System</h1>
    <div id="status-box"><strong>Backend Status:</strong> <span id="backend-message">Connecting...</span></div>

    <div class="container">
        <div class="panel" id="user-panel">
            <h2>User Panel</h2>
            <form id="pickup-form">
                <h3>Schedule a New Pickup</h3>
                <label for="wasteType">Waste Type:</label>
                <input type="text" id="wasteType" name="wasteType" placeholder="e.g., Plastic, E-waste" required>
                <label for="address">Address:</label>
                <input type="text" id="address" name="address" placeholder="e.g., 123 Main St, Anytown" required>
                <button type="submit">Schedule Pickup</button>
            </form>
            <p id="form-message" style="font-weight: bold;"></p>
        </div>

        <div class="panel" id="admin-panel">
            <h2>Admin Panel (All Pickups)</h2>
            <button id="refresh-btn">Refresh Admin List</button>
            <ul id="admin-pickups-list" class="pickup-list">
                <li>Loading pickups...</li>
            </ul>
        </div>

        <div class="panel" id="driver-panel">
            <h2>Driver Panel (Optimized Route)</h2>
            <button id="get-route-btn">Get My Route</button>
            <ol id="route-list">
                <li>Click the button to get your route.</li>
            </ol>
        </div>
    </div>

    <script>
        const backendUrl = 'https://yash-slr-waste-project.onrender.com'; 

        const messageElement = document.getElementById('backend-message');
        const form = document.getElementById('pickup-form');
        const formMessage = document.getElementById('form-message');
        const adminPickupsList = document.getElementById('admin-pickups-list');
        const refreshBtn = document.getElementById('refresh-btn');
        const getRouteBtn = document.getElementById('get-route-btn'); // NEW
        const routeList = document.getElementById('route-list'); // NEW

        function fetchAllPickups() {
            adminPickupsList.innerHTML = '<li>Loading pickups...</li>';
            fetch(backendUrl + '/api/pickups')
                .then(response => response.json())
                .then(data => {
                    adminPickupsList.innerHTML = ''; 
                    if (data.length === 0) {
                        adminPickupsList.innerHTML = '<li>No pickups scheduled.</li>';
                        return;
                    }
                    data.forEach(pickup => {
                        const li = document.createElement('li');
                        li.dataset.id = pickup._id;
                        let statusColor = pickup.status === 'Pending' ? 'orange' : 'green';
                        li.innerHTML = `
                            <strong>${pickup.wasteType}</strong><br>
                            Address: ${pickup.address}<br>
                            Status: <span style="color:${statusColor}; font-weight:bold;">${pickup.status}</span>
                        `;
                        if (pickup.status === 'Pending') {
                            const completeBtn = document.createElement('button');
                            completeBtn.textContent = 'Mark as Completed';
                            completeBtn.className = 'complete-btn';
                            li.appendChild(completeBtn);
                        }
                        adminPickupsList.appendChild(li);
                    });
                })
                .catch(error => { adminPickupsList.innerHTML = '<li>Could not load pickups.</li>'; });
        }
        
        function completePickup(pickupId) {
            fetch(`${backendUrl}/api/pickups/${pickupId}/complete`, { method: 'PATCH' })
                .then(response => response.json())
                .then(data => {
                    if(data.message) {
                        fetchAllPickups(); 
                    }
                })
                .catch(error => { alert('Error: Could not complete pickup.'); });
        }

        function fetchOptimizedRoute() {
            routeList.innerHTML = '<li>Calculating route...</li>';
            fetch(backendUrl + '/api/driver/route')
                .then(response => response.json())
                .then(data => {
                    routeList.innerHTML = ''; 
                    if (data.length === 0) {
                        routeList.innerHTML = '<li>No pending pickups. You are all clear!</li>';
                        return;
                    }
                    data.forEach(pickup => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${pickup.address}</strong> (${pickup.wasteType})`;
                        routeList.appendChild(li);
                    });
                })
                .catch(error => { routeList.innerHTML = '<li>Could not fetch route.</li>'; });
        }

        window.addEventListener('load', () => {
            fetch(backendUrl)
                .then(response => response.text())
                .then(data => { messageElement.textContent = data; messageElement.style.color = 'green'; })
                .catch(error => { messageElement.textContent = 'Could not connect.'; messageElement.style.color = 'red'; });
            
            fetchAllPickups(); 
        });

        form.addEventListener('submit', (event) => {
            event.preventDefault();
            formMessage.textContent = 'Submitting...';
            
            fetch(backendUrl + '/api/schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    wasteType: document.getElementById('wasteType').value, 
                    address: document.getElementById('address').value 
                }),
            })
            .then(response => response.json())
            .then(data => {
                formMessage.textContent = data.message;
                formMessage.style.color = 'green';
                form.reset();
                fetchAllPickups(); // Refresh the admin list
            })
            .catch(error => {
                formMessage.textContent = 'Error: ' + error.message;
                formMessage.style.color = 'red';
            });
        });
        
        refreshBtn.addEventListener('click', fetchAllPickups);
        
        adminPickupsList.addEventListener('click', (event) => {
            if (event.target.classList.contains('complete-btn')) {
                const pickupLi = event.target.closest('li');
                completePickup(pickupLi.dataset.id);
            }
        });

        getRouteBtn.addEventListener('click', fetchOptimizedRoute);

    </script>
</body>
</html>
